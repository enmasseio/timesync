!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var f;"undefined"!=typeof window?f=window:"undefined"!=typeof global?f=global:"undefined"!=typeof self&&(f=self),f.timesync=e()}}(function(){var define,module,exports;return function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s}({1:[function(require,module,exports){"use strict";module.exports=typeof window==="undefined"||typeof window.Promise==="undefined"?require("promise"):window.Promise},{promise:9}],2:[function(require,module,exports){"use strict";module.exports=emitter;function emitter(obj){var _callbacks={};obj.emit=function(event,data){var callbacks=_callbacks[event];callbacks&&callbacks.forEach(function(callback){return callback(data)})};obj.on=function(event,callback){var callbacks=_callbacks[event]||(_callbacks[event]=[]);callbacks.push(callback);return obj};obj.off=function(event,callback){if(callback){var callbacks=_callbacks[event];var index=callbacks.indexOf(callback);if(index!==-1){callbacks.splice(index,1)}if(callbacks.length===0){delete _callbacks[event]}}else{delete _callbacks[event]}return obj};obj.list=function(event){return _callbacks[event]||[]};return obj}},{}],3:[function(require,module,exports){"use strict";exports.fetch=fetch;exports.post=post;Object.defineProperty(exports,"__esModule",{value:true});function fetch(method,url,body,headers,callback){try{var xhr=new XMLHttpRequest;xhr.onreadystatechange=function(){if(xhr.readyState==4){var contentType=xhr.getResponseHeader("Content-Type");if(contentType.indexOf("json")!==-1){callback(null,JSON.parse(xhr.responseText),xhr.status)}else{callback(null,xhr.responseText,xhr.status)}}};if(headers){for(var name in headers){if(headers.hasOwnProperty(name)){xhr.setRequestHeader(name,headers[name])}}}xhr.open(method,url,true);if(typeof body==="string"){xhr.send(body)}else if(body){xhr.setRequestHeader("Content-Type","application/json");xhr.send(JSON.stringify(body))}else{xhr.send()}}catch(err){callback(err,null,0)}}function post(url,body,callback){fetch("POST",url,body,null,callback)}},{}],4:[function(require,module,exports){"use strict";var isBrowser=typeof window!=="undefined";module.exports=isBrowser?require("./request.browser"):require("./request.node")},{"./request.browser":3,"./request.node":5}],5:[function(require,module,exports){"use strict";var _interopRequire=function(obj){return obj&&obj.__esModule?obj["default"]:obj};exports.post=post;Object.defineProperty(exports,"__esModule",{value:true});var http=_interopRequire(require("http"));var url=_interopRequire(require("url"));var parseUrl=url.parse;function post(url,body,callback){var data=body==="string"?body:JSON.stringify(body);var urlObj=parseUrl(url);var options={host:urlObj.hostname,port:urlObj.port,path:urlObj.path,method:"POST",headers:{"Content-Length":data.length}};if(body!=="string"){options.headers["Content-Type"]="application/json"}var req=http.request(options,function(res){res.setEncoding("utf8");res.on("data",function(data){var contentType=res.headers["content-type"];var isJSON=contentType&&contentType.indexOf("json")!==-1;var body=isJSON?JSON.parse(data):data;callback&&callback(null,body,res.statusCode);callback=null})});req.on("error",function(err){callback&&callback(err,null,null);callback=null});req.write(data);req.end()}},{http:undefined,url:undefined}],6:[function(require,module,exports){"use strict";exports.compare=compare;exports.add=add;exports.sum=sum;exports.mean=mean;exports.std=std;exports.variance=variance;exports.median=median;Object.defineProperty(exports,"__esModule",{value:true});function compare(a,b){return a>b?1:a<b?-1:0}function add(a,b){return a+b}function sum(arr){return arr.reduce(add)}function mean(arr){return sum(arr)/arr.length}function std(arr){return Math.sqrt(variance(arr))}function variance(arr){if(arr.length<2){return 0}var _mean=mean(arr);return arr.map(function(x){return Math.pow(x-_mean,2)}).reduce(add)/(arr.length-1)}function median(arr){if(arr.length<2){return arr[0]}var sorted=arr.slice().sort(compare);if(sorted.length%2===0){return(sorted[arr.length/2-1]+sorted[arr.length/2])/2}else{return sorted[(arr.length-1)/2]}}},{}],7:[function(require,module,exports){"use strict";var _interopRequire=function(obj){return obj&&obj.__esModule?obj["default"]:obj};var _interopRequireWildcard=function(obj){return obj&&obj.__esModule?obj:{"default":obj}};exports.create=create;Object.defineProperty(exports,"__esModule",{value:true});var util=_interopRequireWildcard(require("./util.js"));var stat=_interopRequireWildcard(require("./stat.js"));var request=_interopRequireWildcard(require("./request/request"));var emitter=_interopRequire(require("./emitter.js"));var Promise=require("./Promise");function create(options){var timesync={options:{interval:60*60*1e3,timeout:1e4,delay:1e3,repeat:5,peers:[],server:null,now:Date.now},offset:0,_timeout:null,_inProgress:{},_isFirst:true,send:function send(to,data){try{request.post(to,data,function(err,res){if(err){emitError(err)}else{timesync.receive(to,res)}})}catch(err){emitError(err)}},receive:function receive(from,data){if(data===undefined){data=from;from=undefined}if(data&&data.id in timesync._inProgress){timesync._inProgress[data.id](data.result)}else if(data&&data.id!==undefined){timesync.send(from,{jsonrpc:"2.0",id:data.id,result:timesync.now()})}},rpc:function rpc(to,method,params){return new Promise(function(resolve,reject){var id=util.nextId();var timeout=setTimeout(function(){delete timesync._inProgress[id];reject(new Error("Timeout"))},timesync.options.timeout);timesync._inProgress[id]=function(data){clearTimeout(timeout);delete timesync._inProgress[id];resolve(data)};timesync.send(to,{jsonrpc:"2.0",id:id,method:method,params:params})})},sync:function sync(){timesync.emit("sync","start");var peers=timesync.options.server?[timesync.options.server]:timesync.options.peers;return Promise.all(peers.map(function(peer){return timesync._syncWithPeer(peer)})).then(function(all){var offsets=all.filter(function(offset){return timesync._validOffset(offset)});if(offsets.length>0){timesync.offset=stat.mean(offsets);timesync.emit("change",timesync.offset)}timesync.emit("sync","end")})},_validOffset:function _validOffset(offset){return offset!==null&&!isNaN(offset)&&isFinite(offset)},_syncWithPeer:function _syncWithPeer(peer){var all=[];function sync(){return timesync._getOffset(peer).then(function(result){return all.push(result)})}function waitAndSync(){return util.wait(timesync.options.delay).then(sync)}function notDone(){return all.length<timesync.options.repeat}return sync().then(function(){return util.whilst(notDone,waitAndSync)}).then(function(){var results=all.filter(function(result){return result!==null});var roundtrips=results.map(function(result){return result.roundtrip});var limit=stat.median(roundtrips)+stat.std(roundtrips);var filtered=results.filter(function(result){return result.roundtrip<limit});var offsets=filtered.map(function(result){return result.offset});return offsets.length>0?stat.mean(offsets):null})},_getOffset:function _getOffset(peer){var start=Date.now();return timesync.rpc(peer,"timesync").then(function(timestamp){var end=Date.now();var roundtrip=end-start;var offset=timestamp-end+roundtrip/2;if(timesync._isFirst){timesync._isFirst=false;timesync.offset=offset;timesync.emit("change",offset)}return{roundtrip:roundtrip,offset:offset}})["catch"](function(err){return null})},now:function now(){return timesync.options.now()+timesync.offset},destroy:function destroy(){clearTimeout(timesync._timeout)}};if(options){if(options.server&&options.peers){throw new Error('Configure either option "peers" or "server", not both.')}for(var prop in options){if(options.hasOwnProperty(prop)){if(prop==="peers"&&typeof options.peers==="string"){timesync.options.peers=options.peers.split(",").map(function(peer){return peer.trim()}).filter(function(peer){return peer!==""})}else{timesync.options[prop]=options[prop]}}}}emitter(timesync);function emitError(err){if(timesync.list("error").length>0){timesync.emit("error",err)}else{console.log("Error",err)}}if(timesync.options.interval!==null){timesync._timeout=setInterval(timesync.sync,timesync.options.interval);setTimeout(function(){timesync.sync()["catch"](function(err){return emitError(err)})},0)}return timesync}},{"./Promise":1,"./emitter.js":2,"./request/request":4,"./stat.js":6,"./util.js":8}],8:[function(require,module,exports){"use strict";exports.wait=wait;exports.repeat=repeat;exports.whilst=whilst;exports.nextId=nextId;Object.defineProperty(exports,"__esModule",{value:true});var Promise=require("./Promise");function wait(delay){return new Promise(function(resolve){setTimeout(resolve,delay)})}function repeat(fn,times){return new Promise(function(resolve,reject){var count=0;var results=[];function recurse(){if(count<times){count++;fn().then(function(result){results.push(result);recurse()})}else{resolve(results)}}recurse()})}function whilst(condition,callback){return new Promise(function(resolve,reject){function recurse(){if(condition()){callback().then(function(){return recurse()})}else{resolve()}}recurse()})}function nextId(){return _id++}var _id=0},{"./Promise":1}],9:[function(require,module,exports){"use strict";module.exports=require("./lib/core.js");require("./lib/done.js");require("./lib/es6-extensions.js");require("./lib/node-extensions.js")},{"./lib/core.js":10,"./lib/done.js":11,"./lib/es6-extensions.js":12,"./lib/node-extensions.js":13}],10:[function(require,module,exports){"use strict";var asap=require("asap");module.exports=Promise;function Promise(fn){if(typeof this!=="object")throw new TypeError("Promises must be constructed via new");if(typeof fn!=="function")throw new TypeError("not a function");var state=null;var value=null;var deferreds=[];var self=this;this.then=function(onFulfilled,onRejected){return new self.constructor(function(resolve,reject){handle(new Handler(onFulfilled,onRejected,resolve,reject))})};function handle(deferred){if(state===null){deferreds.push(deferred);return}asap(function(){var cb=state?deferred.onFulfilled:deferred.onRejected;if(cb===null){(state?deferred.resolve:deferred.reject)(value);return}var ret;try{ret=cb(value)}catch(e){deferred.reject(e);return}deferred.resolve(ret)})}function resolve(newValue){try{if(newValue===self)throw new TypeError("A promise cannot be resolved with itself.");if(newValue&&(typeof newValue==="object"||typeof newValue==="function")){var then=newValue.then;if(typeof then==="function"){doResolve(then.bind(newValue),resolve,reject);return}}state=true;value=newValue;finale()}catch(e){reject(e)}}function reject(newValue){state=false;value=newValue;finale()}function finale(){for(var i=0,len=deferreds.length;i<len;i++)handle(deferreds[i]);deferreds=null}doResolve(fn,resolve,reject)}function Handler(onFulfilled,onRejected,resolve,reject){this.onFulfilled=typeof onFulfilled==="function"?onFulfilled:null;this.onRejected=typeof onRejected==="function"?onRejected:null;this.resolve=resolve;this.reject=reject}function doResolve(fn,onFulfilled,onRejected){var done=false;try{fn(function(value){if(done)return;done=true;onFulfilled(value)},function(reason){if(done)return;done=true;onRejected(reason)})}catch(ex){if(done)return;done=true;onRejected(ex)}}},{asap:14}],11:[function(require,module,exports){"use strict";var Promise=require("./core.js");var asap=require("asap");module.exports=Promise;Promise.prototype.done=function(onFulfilled,onRejected){var self=arguments.length?this.then.apply(this,arguments):this;self.then(null,function(err){asap(function(){throw err})})}},{"./core.js":10,asap:14}],12:[function(require,module,exports){"use strict";var Promise=require("./core.js");var asap=require("asap");module.exports=Promise;function ValuePromise(value){this.then=function(onFulfilled){if(typeof onFulfilled!=="function")return this;return new Promise(function(resolve,reject){asap(function(){try{resolve(onFulfilled(value))}catch(ex){reject(ex)}})})}}ValuePromise.prototype=Promise.prototype;var TRUE=new ValuePromise(true);var FALSE=new ValuePromise(false);var NULL=new ValuePromise(null);var UNDEFINED=new ValuePromise(undefined);var ZERO=new ValuePromise(0);var EMPTYSTRING=new ValuePromise("");Promise.resolve=function(value){if(value instanceof Promise)return value;if(value===null)return NULL;if(value===undefined)return UNDEFINED;if(value===true)return TRUE;if(value===false)return FALSE;if(value===0)return ZERO;if(value==="")return EMPTYSTRING;if(typeof value==="object"||typeof value==="function"){try{var then=value.then;if(typeof then==="function"){return new Promise(then.bind(value))}}catch(ex){return new Promise(function(resolve,reject){reject(ex)})}}return new ValuePromise(value)};Promise.all=function(arr){var args=Array.prototype.slice.call(arr);return new Promise(function(resolve,reject){if(args.length===0)return resolve([]);var remaining=args.length;function res(i,val){try{if(val&&(typeof val==="object"||typeof val==="function")){var then=val.then;if(typeof then==="function"){then.call(val,function(val){res(i,val)},reject);return}}args[i]=val;if(--remaining===0){resolve(args)}}catch(ex){reject(ex)}}for(var i=0;i<args.length;i++){res(i,args[i])}})};Promise.reject=function(value){return new Promise(function(resolve,reject){reject(value)})};Promise.race=function(values){return new Promise(function(resolve,reject){values.forEach(function(value){Promise.resolve(value).then(resolve,reject)})})};Promise.prototype["catch"]=function(onRejected){return this.then(null,onRejected)}},{"./core.js":10,asap:14}],13:[function(require,module,exports){"use strict";var Promise=require("./core.js");var asap=require("asap");module.exports=Promise;Promise.denodeify=function(fn,argumentCount){argumentCount=argumentCount||Infinity;return function(){var self=this;var args=Array.prototype.slice.call(arguments);return new Promise(function(resolve,reject){while(args.length&&args.length>argumentCount){args.pop()}args.push(function(err,res){if(err)reject(err);else resolve(res)});var res=fn.apply(self,args);if(res&&(typeof res==="object"||typeof res==="function")&&typeof res.then==="function"){resolve(res)}})}};Promise.nodeify=function(fn){return function(){var args=Array.prototype.slice.call(arguments);var callback=typeof args[args.length-1]==="function"?args.pop():null;var ctx=this;try{return fn.apply(this,arguments).nodeify(callback,ctx)}catch(ex){if(callback===null||typeof callback=="undefined"){return new Promise(function(resolve,reject){reject(ex)})}else{asap(function(){callback.call(ctx,ex)})}}}};Promise.prototype.nodeify=function(callback,ctx){if(typeof callback!="function")return this;this.then(function(value){asap(function(){callback.call(ctx,null,value)})},function(err){asap(function(){callback.call(ctx,err)})})}},{"./core.js":10,asap:14}],14:[function(require,module,exports){(function(process){var head={task:void 0,next:null};var tail=head;var flushing=false;var requestFlush=void 0;var isNodeJS=false;function flush(){while(head.next){head=head.next;var task=head.task;head.task=void 0;var domain=head.domain;if(domain){head.domain=void 0;domain.enter()}try{task()}catch(e){if(isNodeJS){if(domain){domain.exit()}setTimeout(flush,0);if(domain){domain.enter()}throw e}else{setTimeout(function(){throw e},0)}}if(domain){domain.exit()}}flushing=false}if(typeof process!=="undefined"&&process.nextTick){isNodeJS=true;requestFlush=function(){process.nextTick(flush)}}else if(typeof setImmediate==="function"){if(typeof window!=="undefined"){requestFlush=setImmediate.bind(window,flush)}else{requestFlush=function(){setImmediate(flush)}}}else if(typeof MessageChannel!=="undefined"){var channel=new MessageChannel;channel.port1.onmessage=flush;requestFlush=function(){channel.port2.postMessage(0)}}else{requestFlush=function(){setTimeout(flush,0)}}function asap(task){tail=tail.next={task:task,domain:isNodeJS&&process.domain,next:null};if(!flushing){flushing=true;requestFlush()}}module.exports=asap}).call(this,require("_process"))},{_process:undefined}]},{},[7])(7)});